id: cappuccino
name: cappuccino

vibversion: 1.0.0
includespath: includes

stages:
  - id: build
    args:
      DEBIAN_FRONTEND: noninteractive
    base: ghcr.io/vanilla-os/desktop:main

    addincludes: true
    singlelayer: false

    runs:
      commands:
        - echo 'APT::Install-Recommends "1";' > /etc/apt/apt.conf.d/01norecommends

    modules:
      - type: shell
        name: system
        commands:
          - lpkg --unlock
          - apt-get update
          - apt-get upgrade -y

      - type: apt
        name: vanilla
        sources:
          - path: vanilla.inst

      - type: includes
        name: modules
        includes:
          - modules/build/atuin.yml
          - modules/build/bandwhich.yml
          - modules/build/dust.yml
          - modules/build/eza.yml
          - modules/build/glow.yml
          - modules/build/lazydocker.yml
          - modules/build/lazygit.yml
          - modules/build/procs.yml
          - modules/build/sd.yml
          - modules/build/starship.yml
          - modules/build/tealdeer.yml
          - modules/build/television.yml
          - modules/build/tokei.yml
          - modules/build/viddy.yml
          - modules/build/uv.yml
          - modules/prebuilt/1password.yml
          - modules/prebuilt/docker.yml
          - modules/prebuilt/flathub.yml
          - modules/prebuilt/tailscale.yml
          - modules/prebuilt/zed-editor.yml
          - modules/fix-flatpak-xcompose.yml
          - modules/set-image-abroot-config.yml

      - type: shell
        name: cleanup-a
        commands:
          - apt-get autoremove -y
          - apt-get clean
          - lpkg --lock

      - type: fsguard
        name: fsguard

        GenerateKey: true
        CustomFsGuard: false

        FilelistPaths: ["/usr/bin"]
        FsGuardLocation: "/usr/sbin/FsGuard"

        modules:
          - type: shell
            name: setup
            commands:
              - rm -rf /FsGuard
              - rm -f ./minisign.pub ./minisign.key
              - chmod +x /usr/sbin/init

      - type: shell
        name: cleanup-b
        commands:
          - rm -rf /tmp/*
          - rm -rf /sources
          - rm -rf /var/tmp/*
